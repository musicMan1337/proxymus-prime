# Keepalived configuration example
# Copy this to keepalived.conf and modify for your environment

# Health check script for nginx
vrrp_script chk_nginx {
    script "/bin/curl -f http://localhost/health || exit 1"
    interval 2          # Check every 2 seconds
    weight -2           # Reduce priority by 2 if check fails
    fall 3              # Require 3 failures before DOWN
    rise 2              # Require 2 successes before UP
}

# VRRP instance configuration
vrrp_instance VI_1 {
    # Server 1 (Primary) configuration:
    state MASTER
    priority 100

    # Server 2+ (Secondary) configuration:
    # state BACKUP
    # priority 90 # Adjust priority for each secondary server

    # Network settings (adjust for your environment)
    interface eth0                   # Network interface name
    virtual_router_id 51             # Must be same on both servers
    advert_int 1                     # Advertisement interval

    # Virtual IP configuration
    virtual_ipaddress {
        192.168.1.100/24             # Adjust to your network subnet
        # 10.0.1.100/24              # Alternative for different networks
        # 172.16.1.100/24            # Docker bridge networks
    }

    # Enable health checking
    track_script {
        chk_nginx
    }

    # Optional: Authentication (recommended for production)
    # authentication {
    #     auth_type PASS
    #     auth_pass your_secret_password
    # }

    # Optional: Notification scripts
    # notify_master "/path/to/script_when_becoming_master.sh"
    # notify_backup "/path/to/script_when_becoming_backup.sh"
    # notify_fault "/path/to/script_when_fault.sh"
}

# Additional VRRP instances (if you need multiple VIPs)
# vrrp_instance VI_2 {
#     state BACKUP
#     interface eth0
#     virtual_router_id 52
#     priority 90
#     advert_int 1
#     virtual_ipaddress {
#         192.168.1.101/24
#     }
# }